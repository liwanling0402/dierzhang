<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>第二章数据可视化平台 - 增强版</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white; min-height: 100vh; line-height: 1.6;
        }
        .header {
            background: rgba(255,255,255,0.1); 
            padding: 30px 0; text-align: center;
            backdrop-filter: blur(10px);
        }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; color: #4ecdc4; }
        .header p { font-size: 1.2rem; opacity: 0.8; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .controls { 
            background: rgba(255,255,255,0.05); 
            padding: 25px; border-radius: 15px; 
            margin-bottom: 25px; backdrop-filter: blur(5px);
        }
        .data-selector { margin-bottom: 20px; }
        .data-selector label { display: block; margin-bottom: 10px; font-weight: bold; }
        .data-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .data-btn { 
            background: #4ecdc4; border: none; color: white; 
            padding: 12px 20px; border-radius: 8px; cursor: pointer; 
            font-size: 14px; transition: all 0.3s ease; position: relative;
        }
        .data-btn:hover { background: #45b7d1; transform: translateY(-2px); }
        .data-btn.active { background: #ff6b6b; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4); }
        .data-btn.loading::after {
            content: ''; position: absolute; right: 10px; top: 50%;
            width: 12px; height: 12px; border: 2px solid transparent;
            border-top: 2px solid white; border-radius: 50%;
            animation: spin 1s linear infinite; transform: translateY(-50%);
        }
        .data-btn.error { background: #ff6b6b; }
        .chart-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .chart-btn { 
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 10px 15px; border-radius: 6px; 
            cursor: pointer; font-size: 14px; transition: all 0.3s ease;
        }
        .chart-btn:hover { background: rgba(255,255,255,0.2); }
        .chart-btn.active { background: #4ecdc4; border-color: #4ecdc4; }
        .chart-container { 
            background: rgba(255,255,255,0.05); 
            padding: 25px; border-radius: 15px; 
            margin-bottom: 25px; backdrop-filter: blur(5px);
            position: relative; min-height: 600px;
        }
        canvas { width: 100% !important; height: 500px !important; }
        .chart-info { 
            margin-top: 20px; padding: 15px; 
            background: rgba(255,255,255,0.05); 
            border-radius: 8px; font-size: 14px; 
            border-left: 4px solid #4ecdc4;
        }
        .data-preview { 
            background: rgba(255,255,255,0.05); 
            padding: 15px; border-radius: 8px; 
            margin-top: 15px; max-height: 200px; overflow-y: auto;
        }
        .loading { 
            text-align: center; padding: 40px; color: #4ecdc4;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .loading-spinner {
            width: 40px; height: 40px; border: 4px solid rgba(78, 205, 196, 0.3);
            border-top: 4px solid #4ecdc4; border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        .data-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .data-table th, .data-table td { 
            padding: 8px; text-align: left; 
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .data-table th { background: rgba(255,255,255,0.1); }
        .performance-info { 
            background: rgba(255,255,255,0.05); padding: 10px;
            border-radius: 5px; margin-top: 10px; font-size: 12px;
        }
        .error-message { 
            background: rgba(255, 107, 107, 0.1); 
            border: 1px solid rgba(255, 107, 107, 0.3);
            color: #ff6b6b; padding: 10px; border-radius: 5px;
            margin-top: 10px; font-size: 12px;
        }
        .stats-panel {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px; margin-top: 15px;
        }
        .stat-item {
            background: rgba(255,255,255,0.05); padding: 10px;
            border-radius: 5px; text-align: center;
        }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: #4ecdc4; }
        .stat-label { font-size: 0.8rem; opacity: 0.8; }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .progress-bar {
            width: 100%; height: 4px; background: rgba(255,255,255,0.1);
            border-radius: 2px; margin-top: 10px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; background: #4ecdc4; width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>第二章数据可视化平台 - 增强版</h1>
        <p>高性能、稳定的交互式数据可视化分析</p>
    </div>

    <div class="container">
        <div class="controls">
            <div class="data-selector">
                <label>选择数据集：</label>
                <div class="data-buttons">
                    <button class="data-btn active" onclick="loadDataset('mpg', event)">汽车数据 (mpg_ggplot2.csv)</button>
                    <button class="data-btn" onclick="loadDataset('usarrests', event)">美国犯罪数据 (USArrests.csv)</button>
                    <button class="data-btn" onclick="loadDataset('cities', event)">美国城市数据 (2014_us_cities.csv)</button>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            
            <div class="chart-buttons">
                <button class="chart-btn active" onclick="showChart('scatter')">散点图</button>
                <button class="chart-btn" onclick="showChart('bar')">柱状图</button>
                <button class="chart-btn" onclick="showChart('line')">折线图</button>
                <button class="chart-btn" onclick="showChart('pie')">饼图</button>
                <button class="chart-btn" onclick="showChart('histogram')">直方图</button>
                <button class="chart-btn" onclick="showChart('radar')">雷达图</button>
                <button class="chart-btn" onclick="showChart('bubble')">气泡图</button>
            </div>
        </div>

        <div class="chart-container">
            <div id="loading" class="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>正在加载数据...</p>
            </div>
            <canvas id="myChart"></canvas>
            <div class="chart-info" id="chartInfo"></div>
            <div class="stats-panel" id="statsPanel"></div>
            <div class="data-preview" id="dataPreview"></div>
            <div class="performance-info" id="performanceInfo"></div>
            <div class="error-message" id="errorMessage" style="display: none;"></div>
        </div>
    </div>

    <script>
        let currentChart = null;
        let currentDataset = null;
        let currentDataType = 'mpg';
        let datasetsCache = {};
        let retryCounts = {};
        const MAX_RETRIES = 3;
        
        // 颜色配置
        const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#feca57', '#ff9ff3', '#54a0ff', '#5f27cd'];
        
        // 数据集描述
        const datasetInfo = {
            mpg: {
                name: '汽车燃油效率数据',
                description: '包含不同制造商、车型的排量、油耗等数据',
                file: 'https://raw.githubusercontent.com/liwanling0402/dierzhang/main/素材/mpg_ggplot2.csv',
                sampleSize: 236,
                backupFile: './素材/mpg_ggplot2.csv'
            },
            usarrests: {
                name: '美国各州犯罪数据',
                description: '包含各州的谋杀、袭击、强奸等犯罪率数据',
                file: 'https://raw.githubusercontent.com/liwanling0402/dierzhang/main/素材/USArrests.csv',
                sampleSize: 50,
                backupFile: './素材/USArrests.csv'
            },
            cities: {
                name: '美国城市人口数据',
                description: '包含美国主要城市的人口数量和地理位置数据',
                file: 'https://raw.githubusercontent.com/liwanling0402/dierzhang/main/素材/2014_us_cities.csv',
                sampleSize: 3228,
                backupFile: './素材/2014_us_cities.csv'
            }
        };
        
        // 图表类型描述
        const chartDescriptions = {
            scatter: "散点图 - 显示两个连续变量之间的关系，适合相关性分析",
            bar: "柱状图 - 比较不同类别的数值大小，适合分类数据对比",
            line: "折线图 - 显示数据随时间或其他连续变量的趋势变化",
            pie: "饼图 - 显示各部分占整体的比例关系",
            histogram: "直方图 - 显示数据分布频率，分析数据分布特征",
            radar: "雷达图 - 多维数据对比分析，展示综合表现",
            bubble: "气泡图 - 三个维度的数据可视化，气泡大小表示第三个变量"
        };

        // 显示错误信息
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // 更新进度条
        function updateProgress(percent) {
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = percent + '%';
        }

        // 数据验证和清理
        function validateAndCleanData(data, type) {
            if (!data || !Array.isArray(data)) {
                throw new Error('无效的数据格式');
            }
            
            const cleanedData = data.filter(row => {
                // 基本验证：确保行不是空对象
                if (!row || typeof row !== 'object') return false;
                
                // 根据数据类型进行特定验证
                switch(type) {
                    case 'mpg':
                        return row.manufacturer && row.displ && row.cty;
                    case 'usarrests':
                        return row.State && row.Murder && row.Assault;
                    case 'cities':
                        return row.name && row.pop && row.lat && row.lon;
                    default:
                        return Object.keys(row).length > 0;
                }
            });
            
            if (cleanedData.length === 0) {
                throw new Error('数据验证失败：没有有效的数据记录');
            }
            
            console.log(`数据验证：原始 ${data.length} 条，有效 ${cleanedData.length} 条`);
            return cleanedData;
        }

        // 预加载数据（优化性能）
        function preloadDatasets() {
            Object.keys(datasetInfo).forEach(type => {
                if (!datasetsCache[type]) {
                    setTimeout(() => loadDatasetData(type), 100); // 延迟加载避免阻塞
                }
            });
        }

        // 加载数据集数据（带重试机制）
        async function loadDatasetData(type, retry = 0) {
            return new Promise((resolve, reject) => {
                if (datasetsCache[type]) {
                    resolve(datasetsCache[type]);
                    return;
                }

                const startTime = performance.now();
                const fileUrl = retry === 0 ? datasetInfo[type].file : datasetInfo[type].backupFile;
                
                Papa.parse(fileUrl, {
                    download: true,
                    header: true,
                    beforeFirstChunk: function() {
                        updateProgress(30);
                    },
                    chunk: function() {
                        updateProgress(60);
                    },
                    complete: function(results) {
                        const endTime = performance.now();
                        try {
                            const cleanedData = validateAndCleanData(results.data, type);
                            datasetsCache[type] = {
                                data: cleanedData,
                                loadTime: (endTime - startTime).toFixed(2),
                                source: fileUrl
                            };
                            updateProgress(100);
                            console.log(`数据集 ${type} 加载成功，耗时: ${datasetsCache[type].loadTime}ms`);
                            resolve(datasetsCache[type]);
                        } catch (error) {
                            reject(error);
                        }
                    },
                    error: function(error) {
                        console.error(`数据加载错误 (尝试 ${retry + 1}/${MAX_RETRIES}):`, error);
                        
                        if (retry < MAX_RETRIES) {
                            setTimeout(() => {
                                loadDatasetData(type, retry + 1).then(resolve).catch(reject);
                            }, 1000 * (retry + 1)); // 指数退避
                        } else {
                            reject(new Error(`数据加载失败: ${error.message}`));
                        }
                    }
                });
            });
        }

        // 加载数据集
        async function loadDataset(type, event) {
            currentDataType = type;
            document.querySelectorAll('.data-btn').forEach(btn => {
                btn.classList.remove('active', 'loading', 'error');
            });
            
            if (event && event.target) {
                event.target.classList.add('loading');
            }

            // 显示加载动画
            document.getElementById('loading').style.display = 'block';
            document.getElementById('myChart').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            updateProgress(0);

            try {
                const dataset = await loadDatasetData(type);
                currentDataset = dataset.data;
                
                // 移除加载状态
                if (event && event.target) {
                    event.target.classList.remove('loading');
                    event.target.classList.add('active');
                }

                document.getElementById('loading').style.display = 'none';
                document.getElementById('myChart').style.display = 'block';
                
                // 显示数据预览和性能信息
                showDataPreview();
                showPerformanceInfo(dataset.loadTime);
                showStatistics();
                
                // 默认显示散点图
                showChart('scatter');
            } catch (error) {
                if (event && event.target) {
                    event.target.classList.remove('loading');
                    event.target.classList.add('error');
                }
                showError(`数据加载失败: ${error.message}`);
                console.error('加载失败:', error);
            }
        }

        // 显示统计信息
        function showStatistics() {
            if (!currentDataset || currentDataset.length === 0) return;
            
            const statsPanel = document.getElementById('statsPanel');
            const headers = Object.keys(currentDataset[0]);
            
            let statsHtml = '';
            
            // 基本统计
            statsHtml += `
                <div class="stat-item">
                    <div class="stat-value">${currentDataset.length}</div>
                    <div class="stat-label">总记录数</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${headers.length}</div>
                    <div class="stat-label">数据列数</div>
                </div>
            `;
            
            // 数值型数据的统计
            const numericColumns = headers.filter(header => {
                const sampleValue = currentDataset[0][header];
                return !isNaN(parseFloat(sampleValue)) && sampleValue !== '';
            });
            
            if (numericColumns.length > 0) {
                const firstNumeric = numericColumns[0];
                const values = currentDataset.map(d => parseFloat(d[firstNumeric])).filter(v => !isNaN(v));
                if (values.length > 0) {
                    const avg = (values.reduce((a, b) => a + b) / values.length).toFixed(2);
                    statsHtml += `
                        <div class="stat-item">
                            <div class="stat-value">${avg}</div>
                            <div class="stat-label">${firstNumeric}平均值</div>
                        </div>
                    `;
                }
            }
            
            statsPanel.innerHTML = statsHtml;
        }

        // 显示性能信息
        function showPerformanceInfo(loadTime) {
            const info = document.getElementById('performanceInfo');
            const memory = performance.memory ? 
                ` | 内存使用: ${(performance.memory.usedJSHeapSize / 1048576).toFixed(1)}MB` : '';
                
            info.innerHTML = `
                <strong>性能信息：</strong>
                数据加载: ${loadTime}ms | 
                记录数量: ${currentDataset.length}${memory}
            `;
        }

        // 显示数据预览
        function showDataPreview() {
            const preview = document.getElementById('dataPreview');
            if (!currentDataset || currentDataset.length === 0) {
                preview.innerHTML = '<p>无数据可显示</p>';
                return;
            }
            
            const headers = Object.keys(currentDataset[0]);
            let html = `<h4>数据预览 (前5行)</h4>`;
            html += `<table class="data-table">`;
            html += `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
            
            currentDataset.slice(0, 5).forEach(row => {
                html += `<tr>${headers.map(h => `<td>${row[h] || ''}</td>`).join('')}</tr>`;
            });
            
            html += `</table>`;
            html += `<p>总记录数: ${currentDataset.length} | 数据列数: ${headers.length}</p>`;
            preview.innerHTML = html;
        }

        // 显示图表（优化渲染性能）
        function showChart(type) {
            if (!currentDataset) return;
            
            // 更新按钮状态
            document.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // 更新图表描述
            document.getElementById('chartInfo').innerHTML = 
                `<strong>${chartDescriptions[type]}</strong><br>数据集: ${datasetInfo[currentDataType].name}`;
            
            // 销毁现有图表
            if (currentChart) {
                currentChart.destroy();
            }
            
            const ctx = document.getElementById('myChart').getContext('2d');
            const renderStart = performance.now();
            
            // 使用requestAnimationFrame优化渲染
            requestAnimationFrame(() => {
                try {
                    switch(type) {
                        case 'scatter':
                            createScatterChart(ctx);
                            break;
                        case 'bar':
                            createBarChart(ctx);
                            break;
                        case 'line':
                            createLineChart(ctx);
                            break;
                        case 'pie':
                            createPieChart(ctx);
                            break;
                        case 'histogram':
                            createHistogramChart(ctx);
                            break;
                        case 'radar':
                            createRadarChart(ctx);
                            break;
                        case 'bubble':
                            createBubbleChart(ctx);
                            break;
                    }
                    
                    const renderEnd = performance.now();
                    const currentPerf = document.getElementById('performanceInfo');
                    if (currentPerf) {
                        currentPerf.innerHTML += ` | 图表渲染: ${(renderEnd - renderStart).toFixed(2)}ms`;
                    }
                } catch (error) {
                    showError(`图表生成失败: ${error.message}`);
                    console.error('图表生成错误:', error);
                }
            });
        }

        // 创建散点图（优化版）
        function createScatterChart(ctx) {
            let xData, yData, label;
            
            if (currentDataType === 'mpg') {
                // 使用智能采样
                const sampleData = currentDataset.length > 100 ? 
                    currentDataset.filter((_, i) => i % Math.ceil(currentDataset.length / 100) === 0) : currentDataset;
                xData = sampleData.map(d => parseFloat(d.displ) || 0);
                yData = sampleData.map(d => parseFloat(d.cty) || 0);
                label = '城市油耗 vs 排量';
            } else if (currentDataType === 'usarrests') {
                xData = currentDataset.map(d => parseFloat(d.Assault) || 0);
                yData = currentDataset.map(d => parseFloat(d.Murder) || 0);
                label = '谋杀率 vs 袭击率';
            } else {
                // 对城市数据采样
                const sampleData = currentDataset.length > 500 ? 
                    currentDataset.filter((_, i) => i % Math.ceil(currentDataset.length / 200) === 0) : currentDataset;
                xData = sampleData.map(d => parseFloat(d.lon) || 0);
                yData = sampleData.map(d => parseFloat(d.lat) || 0);
                label = '城市地理位置';
            }
            
            const scatterData = xData.map((x, i) => ({x: x, y: yData[i]}));
            
            currentChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: label,
                        data: scatterData,
                        backgroundColor: colors[0],
                        pointRadius: Math.max(2, 8 - Math.log10(currentDataset.length))
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: Math.min(1000, 2000 / Math.log10(currentDataset.length + 1))
                    },
                    scales: {
                        x: { title: { display: true, text: 'X轴' } },
                        y: { title: { display: true, text: 'Y轴' } }
                    }
                }
            });
        }

        // 其他图表函数保持类似优化...
        function createBarChart(ctx) {
            let labels, data, label;
            
            if (currentDataType === 'mpg') {
                const manufacturerCount = {};
                currentDataset.forEach(d => {
                    manufacturerCount[d.manufacturer] = (manufacturerCount[d.manufacturer] || 0) + 1;
                });
                labels = Object.keys(manufacturerCount).slice(0, 15); // 限制显示数量
                data = labels.map(label => manufacturerCount[label]);
                label = '各制造商车型数量';
            } else if (currentDataType === 'usarrests') {
                labels = currentDataset.map(d => d.State).slice(0, 15);
                data = currentDataset.slice(0, 15).map(d => parseFloat(d.Murder) || 0);
                label = '各州谋杀率';
            } else {
                const sortedCities = currentDataset
                    .sort((a, b) => (parseFloat(b.pop) || 0) - (parseFloat(a.pop) || 0))
                    .slice(0, 10);
                labels = sortedCities.map(d => d.name);
                data = sortedCities.map(d => (parseFloat(d.pop) || 0) / 1000000);
                label = '人口最多的10个城市 (百万)';
            }
            
            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 800 }
                }
            });
        }

        // 简化的其他图表实现...
        function createLineChart(ctx) { createBarChart(ctx); currentChart.config.type = 'line'; currentChart.update(); }
        function createPieChart(ctx) { createBarChart(ctx); currentChart.config.type = 'pie'; currentChart.update(); }
        function createHistogramChart(ctx) { createBarChart(ctx); }
        function createRadarChart(ctx) { 
            if (currentDataType === 'usarrests') {
                const states = currentDataset.slice(0, 3);
                const labels = ['Murder', 'Assault', 'UrbanPop', 'Rape'];
                currentChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: states.map((state, i) => ({
                            label: state.State,
                            data: [
                                parseFloat(state.Murder) || 0,
                                (parseFloat(state.Assault) || 0) / 10,
                                parseFloat(state.UrbanPop) || 0,
                                parseFloat(state.Rape) || 0
                            ],
                            backgroundColor: colors[i] + '20',
                            borderColor: colors[i]
                        }))
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
        }
        function createBubbleChart(ctx) { createScatterChart(ctx); currentChart.config.type = 'bubble'; currentChart.update(); }

        // 初始化时预加载数据
        window.addEventListener('load', function() {
            preloadDatasets();
            setTimeout(() => loadDataset('mpg'), 500); // 延迟加载确保页面完全加载
        });

        // 添加性能监控
        window.addEventListener('beforeunload', function() {
            if (currentChart) {
                currentChart.destroy();
            }
        });
    </script>
</body>
</html>