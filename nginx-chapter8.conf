# Nginx 服务器配置
# 用于 022340611.xyz 域名的第8章数据可视化平台

server {
    listen 80;
    listen [::]:80;
    server_name 022340611.xyz;
    
    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name 022340611.xyz;
    
    # SSL证书配置
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    # 根目录
    root /var/www/html;
    index index.html index.htm;
    
    # 访问日志
    access_log /var/log/nginx/022340611_xyz.access.log;
    error_log /var/log/nginx/022340611_xyz.error.log;
    
    # 第8章平台专用路由
    location /chapter8 {
        return 301 /chapter8_final.html;
    }
    
    location /chapter8/ {
        return 301 /chapter8_final.html;
    }
    
    location = /chapter8_final.html {
        # 文件存在性检查
        try_files $uri =404;
        
        # 字符编码
        charset utf-8;
        
        # 安全头设置
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        
        # CORS设置（允许CDN资源）
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type" always;
        
        # 缓存设置（HTML不缓存，确保实时更新）
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
    }
    
    # 静态资源缓存设置
    location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin "*";
        
        # 压缩设置
        gzip_static on;
    }
    
    # CDN资源代理（可选，提高加载速度）
    location ~ ^/(cdn|static)/ {
        proxy_pass https://cdn.jsdelivr.net/;
        proxy_set_header Host cdn.jsdelivr.net;
        proxy_cache_valid 200 1y;
        add_header X-Cache-Status "PROXY";
    }
    
    # Gzip压缩设置
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/xml+rss
        application/json
        image/svg+xml
        application/x-font-ttf
        application/font-woff
        application/font-woff2;
    
    # 安全设置
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # 禁止访问敏感文件
    location ~* \.(log|md|txt|yml|json|sh|conf)$ {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # 错误页面
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
    
    location = /404.html {
        root /var/www/error;
    }
    
    location = /50x.html {
        root /var/www/error;
    }
    
    # 限制请求大小
    client_max_body_size 10M;
    
    # 连接超时设置
    client_body_timeout 60s;
    client_header_timeout 60s;
    keepalive_timeout 65s;
    send_timeout 60s;
}

# HTTP/2 配置优化
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name 022340611.xyz;
    
    # HTTP/2 推送关键资源
    http2_push /chapter8_final.html;
    http2_push /cdn/plotly-latest.min.js;
    http2_push /cdn/chart.js;
    
    # 其他配置同上...
    include /etc/nginx/conf.d/022340611_xyz_common.conf;
}