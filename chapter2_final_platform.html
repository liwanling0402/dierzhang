<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>第二章数据可视化平台 - 最终版</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white; min-height: 100vh; line-height: 1.6;
        }
        .header {
            background: rgba(255,255,255,0.1); 
            padding: 30px 0; text-align: center;
            backdrop-filter: blur(10px);
        }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; color: #4ecdc4; }
        .header p { font-size: 1.2rem; opacity: 0.8; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .controls { 
            background: rgba(255,255,255,0.05); 
            padding: 25px; border-radius: 15px; 
            margin-bottom: 25px; backdrop-filter: blur(5px);
        }
        .data-selector { margin-bottom: 20px; }
        .data-selector label { display: block; margin-bottom: 10px; font-weight: bold; }
        .data-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .data-btn { 
            background: #4ecdc4; border: none; color: white; 
            padding: 12px 20px; border-radius: 8px; cursor: pointer; 
            font-size: 14px; transition: all 0.3s ease;
        }
        .data-btn:hover { background: #45b7d1; transform: translateY(-2px); }
        .data-btn.active { background: #ff6b6b; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4); }
        .chart-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .chart-btn { 
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 10px 15px; border-radius: 6px; 
            cursor: pointer; font-size: 14px; transition: all 0.3s ease;
        }
        .chart-btn:hover { background: rgba(255,255,255,0.2); }
        .chart-btn.active { background: #4ecdc4; border-color: #4ecdc4; }
        .chart-container { 
            background: rgba(255,255,255,0.05); 
            padding: 25px; border-radius: 15px; 
            margin-bottom: 25px; backdrop-filter: blur(5px);
            position: relative; min-height: 600px;
        }
        canvas { width: 100% !important; height: 500px !important; }
        .chart-info { 
            margin-top: 20px; padding: 15px; 
            background: rgba(255,255,255,0.05); 
            border-radius: 8px; font-size: 14px; 
            border-left: 4px solid #4ecdc4;
        }
        .data-preview { 
            background: rgba(255,255,255,0.05); 
            padding: 15px; border-radius: 8px; 
            margin-top: 15px; max-height: 200px; overflow-y: auto;
        }
        .performance-info { 
            background: rgba(255,255,255,0.05); padding: 10px;
            border-radius: 5px; margin-top: 10px; font-size: 12px;
        }
        .stats-panel {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px; margin-top: 15px;
        }
        .stat-item {
            background: rgba(255,255,255,0.05); padding: 10px;
            border-radius: 5px; text-align: center;
        }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: #4ecdc4; }
        .stat-label { font-size: 0.8rem; opacity: 0.8; }
    </style>
</head>
<body>
    <div class="header">
        <h1>第二章数据可视化平台 - 最终版</h1>
        <p>基于第二章文档数据的快速可视化分析</p>
    </div>

    <div class="container">
        <div class="controls">
            <div class="data-selector">
                <label>选择数据集：</label>
                <div class="data-buttons">
                    <button class="data-btn active" onclick="loadDataset('exam')">考试成绩数据</button>
                    <button class="data-btn" onclick="loadDataset('sales')">销售数据</button>
                    <button class="data-btn" onclick="loadDataset('population')">人口数据</button>
                    <button class="data-btn" onclick="loadDataset('weather')">天气数据</button>
                </div>
            </div>
            
            <div class="chart-buttons">
                <button class="chart-btn active" onclick="showChart('scatter')">散点图</button>
                <button class="chart-btn" onclick="showChart('bar')">柱状图</button>
                <button class="chart-btn" onclick="showChart('line')">折线图</button>
                <button class="chart-btn" onclick="showChart('pie')">饼图</button>
                <button class="chart-btn" onclick="showChart('histogram')">直方图</button>
                <button class="chart-btn" onclick="showChart('radar')">雷达图</button>
                <button class="chart-btn" onclick="showChart('bubble')">气泡图</button>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="myChart"></canvas>
            <div class="chart-info" id="chartInfo"></div>
            <div class="stats-panel" id="statsPanel"></div>
            <div class="data-preview" id="dataPreview"></div>
            <div class="performance-info" id="performanceInfo"></div>
        </div>
    </div>

    <script>
        let currentChart = null;
        let currentDataset = null;
        let currentDataType = 'exam';
        
        // 颜色配置
        const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#feca57', '#ff9ff3', '#54a0ff', '#5f27cd'];
        
        // 基于第二章文档的示例数据
        const datasetInfo = {
            exam: {
                name: '考试成绩数据',
                description: '学生各科目考试成绩数据',
                data: [
                    { student: '张三', math: 85, english: 78, science: 92, history: 80 },
                    { student: '李四', math: 92, english: 85, science: 88, history: 76 },
                    { student: '王五', math: 78, english: 90, science: 85, history: 82 },
                    { student: '赵六', math: 88, english: 82, science: 79, history: 85 },
                    { student: '钱七', math: 95, english: 88, science: 91, history: 78 },
                    { student: '孙八', math: 82, english: 79, science: 84, history: 90 },
                    { student: '周九', math: 90, english: 85, science: 87, history: 83 },
                    { student: '吴十', math: 87, english: 92, science: 80, history: 79 }
                ]
            },
            sales: {
                name: '销售数据',
                description: '各产品季度销售额数据',
                data: [
                    { product: '产品A', Q1: 120, Q2: 150, Q3: 180, Q4: 200 },
                    { product: '产品B', Q1: 80, Q2: 110, Q3: 130, Q4: 160 },
                    { product: '产品C', Q1: 200, Q2: 180, Q3: 220, Q4: 240 },
                    { product: '产品D', Q1: 90, Q2: 120, Q3: 140, Q4: 170 },
                    { product: '产品E', Q1: 150, Q2: 170, Q3: 190, Q4: 210 }
                ]
            },
            population: {
                name: '人口数据',
                description: '城市人口和面积数据',
                data: [
                    { city: '北京', population: 2154, area: 16410, density: 131 },
                    { city: '上海', population: 2428, area: 6340, density: 383 },
                    { city: '广州', population: 1530, area: 7434, density: 206 },
                    { city: '深圳', population: 1756, area: 1997, density: 879 },
                    { city: '成都', population: 1658, area: 14335, density: 116 },
                    { city: '武汉', population: 1121, area: 8569, density: 131 },
                    { city: '西安', population: 1295, area: 10752, density: 120 },
                    { city: '杭州', population: 1036, area: 16850, density: 61 }
                ]
            },
            weather: {
                name: '天气数据',
                description: '城市温度和降水量数据',
                data: [
                    { city: '北京', temperature: 12.5, precipitation: 580, humidity: 60 },
                    { city: '上海', temperature: 16.2, precipitation: 1150, humidity: 75 },
                    { city: '广州', temperature: 22.1, precipitation: 1720, humidity: 78 },
                    { city: '深圳', temperature: 23.5, precipitation: 1930, humidity: 80 },
                    { city: '成都', temperature: 16.8, precipitation: 870, humidity: 82 },
                    { city: '武汉', temperature: 17.3, precipitation: 1260, humidity: 76 },
                    { city: '西安', temperature: 14.2, precipitation: 580, humidity: 68 },
                    { city: '杭州', temperature: 17.5, precipitation: 1450, humidity: 78 }
                ]
            }
        };
        
        // 图表类型描述
        const chartDescriptions = {
            scatter: "散点图 - 显示两个连续变量之间的关系，适合相关性分析",
            bar: "柱状图 - 比较不同类别的数值大小，适合分类数据对比",
            line: "折线图 - 显示数据随时间或其他连续变量的趋势变化",
            pie: "饼图 - 显示各部分占整体的比例关系",
            histogram: "直方图 - 显示数据分布频率，分析数据分布特征",
            radar: "雷达图 - 多维数据对比分析，展示综合表现",
            bubble: "气泡图 - 三个维度的数据可视化，气泡大小表示第三个变量"
        };

        // 加载数据集（立即加载，无需网络请求）
        function loadDataset(type) {
            currentDataType = type;
            document.querySelectorAll('.data-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            currentDataset = datasetInfo[type].data;
            
            // 显示数据预览和统计信息
            showDataPreview();
            showStatistics();
            
            // 默认显示散点图
            showChart('scatter');
            
            // 显示性能信息（本地数据，加载时间为0）
            document.getElementById('performanceInfo').innerHTML = 
                `<strong>性能信息：</strong>数据加载: 0ms | 记录数量: ${currentDataset.length} | 图表渲染: 实时`;
        }

        // 显示统计信息
        function showStatistics() {
            if (!currentDataset || currentDataset.length === 0) return;
            
            const statsPanel = document.getElementById('statsPanel');
            const headers = Object.keys(currentDataset[0]).filter(h => h !== 'student' && h !== 'product' && h !== 'city');
            
            let statsHtml = '';
            
            // 基本统计
            statsHtml += `
                <div class="stat-item">
                    <div class="stat-value">${currentDataset.length}</div>
                    <div class="stat-label">总记录数</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${headers.length}</div>
                    <div class="stat-label">数值列数</div>
                </div>
            `;
            
            // 显示第一个数值列的平均值
            if (headers.length > 0) {
                const firstNumeric = headers[0];
                const values = currentDataset.map(d => d[firstNumeric]).filter(v => !isNaN(v));
                if (values.length > 0) {
                    const avg = (values.reduce((a, b) => a + b) / values.length).toFixed(1);
                    statsHtml += `
                        <div class="stat-item">
                            <div class="stat-value">${avg}</div>
                            <div class="stat-label">${firstNumeric}平均值</div>
                        </div>
                    `;
                }
            }
            
            statsPanel.innerHTML = statsHtml;
        }

        // 显示数据预览
        function showDataPreview() {
            const preview = document.getElementById('dataPreview');
            if (!currentDataset || currentDataset.length === 0) {
                preview.innerHTML = '<p>无数据可显示</p>';
                return;
            }
            
            const headers = Object.keys(currentDataset[0]);
            let html = `<h4>数据预览 (前5行)</h4>`;
            html += `<table class="data-table">`;
            html += `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
            
            currentDataset.slice(0, 5).forEach(row => {
                html += `<tr>${headers.map(h => `<td>${row[h] || ''}</td>`).join('')}</tr>`;
            });
            
            html += `</table>`;
            html += `<p>总记录数: ${currentDataset.length} | 数据列数: ${headers.length}</p>`;
            preview.innerHTML = html;
        }

        // 显示图表（优化渲染性能）
        function showChart(type) {
            if (!currentDataset) return;
            
            // 更新按钮状态
            document.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // 更新图表描述
            document.getElementById('chartInfo').innerHTML = 
                `<strong>${chartDescriptions[type]}</strong><br>数据集: ${datasetInfo[currentDataType].name}`;
            
            // 销毁现有图表
            if (currentChart) {
                currentChart.destroy();
            }
            
            const ctx = document.getElementById('myChart').getContext('2d');
            const renderStart = performance.now();
            
            // 使用requestAnimationFrame优化渲染
            requestAnimationFrame(() => {
                try {
                    switch(type) {
                        case 'scatter':
                            createScatterChart(ctx);
                            break;
                        case 'bar':
                            createBarChart(ctx);
                            break;
                        case 'line':
                            createLineChart(ctx);
                            break;
                        case 'pie':
                            createPieChart(ctx);
                            break;
                        case 'histogram':
                            createHistogramChart(ctx);
                            break;
                        case 'radar':
                            createRadarChart(ctx);
                            break;
                        case 'bubble':
                            createBubbleChart(ctx);
                            break;
                    }
                    
                    const renderEnd = performance.now();
                    document.getElementById('performanceInfo').innerHTML += 
                        ` | 图表渲染: ${(renderEnd - renderStart).toFixed(2)}ms`;
                } catch (error) {
                    console.error('图表生成错误:', error);
                }
            });
        }

        // 创建散点图
        function createScatterChart(ctx) {
            let xData, yData, label;
            
            if (currentDataType === 'exam') {
                xData = currentDataset.map(d => d.math);
                yData = currentDataset.map(d => d.english);
                label = '数学成绩 vs 英语成绩';
            } else if (currentDataType === 'sales') {
                xData = currentDataset.map(d => d.Q1);
                yData = currentDataset.map(d => d.Q2);
                label = '第一季度 vs 第二季度销售额';
            } else if (currentDataType === 'population') {
                xData = currentDataset.map(d => d.population);
                yData = currentDataset.map(d => d.area);
                label = '人口 vs 面积';
            } else {
                xData = currentDataset.map(d => d.temperature);
                yData = currentDataset.map(d => d.precipitation);
                label = '温度 vs 降水量';
            }
            
            const scatterData = xData.map((x, i) => ({x: x, y: yData[i]}));
            
            currentChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: label,
                        data: scatterData,
                        backgroundColor: colors[0],
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 800 },
                    scales: {
                        x: { title: { display: true, text: 'X轴' } },
                        y: { title: { display: true, text: 'Y轴' } }
                    }
                }
            });
        }

        // 创建柱状图
        function createBarChart(ctx) {
            let labels, data, label;
            
            if (currentDataType === 'exam') {
                labels = currentDataset.map(d => d.student);
                data = currentDataset.map(d => d.math);
                label = '学生数学成绩';
            } else if (currentDataType === 'sales') {
                labels = currentDataset.map(d => d.product);
                data = currentDataset.map(d => d.Q4);
                label = '产品第四季度销售额';
            } else if (currentDataType === 'population') {
                labels = currentDataset.map(d => d.city);
                data = currentDataset.map(d => d.population);
                label = '城市人口数量';
            } else {
                labels = currentDataset.map(d => d.city);
                data = currentDataset.map(d => d.temperature);
                label = '城市平均温度';
            }
            
            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 800 }
                }
            });
        }

        // 创建折线图
        function createLineChart(ctx) {
            let labels, datasets;
            
            if (currentDataType === 'exam') {
                labels = currentDataset.map(d => d.student);
                datasets = [
                    { label: '数学成绩', data: currentDataset.map(d => d.math), borderColor: colors[0] },
                    { label: '英语成绩', data: currentDataset.map(d => d.english), borderColor: colors[1] }
                ];
            } else if (currentDataType === 'sales') {
                labels = currentDataset.map(d => d.product);
                datasets = [
                    { label: 'Q1', data: currentDataset.map(d => d.Q1), borderColor: colors[0] },
                    { label: 'Q2', data: currentDataset.map(d => d.Q2), borderColor: colors[1] },
                    { label: 'Q3', data: currentDataset.map(d => d.Q3), borderColor: colors[2] },
                    { label: 'Q4', data: currentDataset.map(d => d.Q4), borderColor: colors[3] }
                ];
            } else {
                createBarChart(ctx);
                currentChart.config.type = 'line';
                currentChart.update();
                return;
            }
            
            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets.map(dataset => ({
                        ...dataset,
                        fill: false,
                        tension: 0.1
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 800 }
                }
            });
        }

        // 创建饼图
        function createPieChart(ctx) {
            let labels, data;
            
            if (currentDataType === 'exam') {
                const totalScores = currentDataset.map(d => d.math + d.english + d.science + d.history);
                labels = currentDataset.map(d => d.student);
                data = totalScores;
            } else if (currentDataType === 'sales') {
                const totalSales = currentDataset.map(d => d.Q1 + d.Q2 + d.Q3 + d.Q4);
                labels = currentDataset.map(d => d.product);
                data = totalSales;
            } else {
                labels = currentDataset.map(d => d.city);
                data = currentDataType === 'population' ? 
                    currentDataset.map(d => d.population) : 
                    currentDataset.map(d => d.temperature);
            }
            
            currentChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 800 }
                }
            });
        }

        // 创建直方图
        function createHistogramChart(ctx) {
            let data;
            
            if (currentDataType === 'exam') {
                data = currentDataset.map(d => d.math);
            } else if (currentDataType === 'sales') {
                data = currentDataset.map(d => d.Q1 + d.Q2 + d.Q3 + d.Q4);
            } else {
                data = currentDataType === 'population' ? 
                    currentDataset.map(d => d.population) : 
                    currentDataset.map(d => d.temperature);
            }
            
            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    datasets: [{
                        label: '数据分布',
                        data: data,
                        backgroundColor: colors[0]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 800 }
                }
            });
        }

        // 创建雷达图
        function createRadarChart(ctx) {
            let labels, datasets;
            
            if (currentDataType === 'exam') {
                labels = ['数学', '英语', '科学', '历史'];
                datasets = currentDataset.map((student, i) => ({
                    label: student.student,
                    data: [student.math, student.english, student.science, student.history],
                    backgroundColor: colors[i] + '20',
                    borderColor: colors[i]
                }));
            } else if (currentDataType === 'sales') {
                labels = ['Q1', 'Q2', 'Q3', 'Q4'];
                datasets = currentDataset.map((product, i) => ({
                    label: product.product,
                    data: [product.Q1, product.Q2, product.Q3, product.Q4],
                    backgroundColor: colors[i] + '20',
                    borderColor: colors[i]
                }));
            } else {
                document.getElementById('chartInfo').innerHTML = 
                    '<strong>雷达图最适合考试成绩和销售数据</strong>';
                return;
            }
            
            currentChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 800 }
                }
            });
        }

        // 创建气泡图
        function createBubbleChart(ctx) {
            let data;
            
            if (currentDataType === 'population') {
                data = currentDataset.map(d => ({
                    x: d.population,
                    y: d.area,
                    r: d.density / 10
                }));
            } else if (currentDataType === 'weather') {
                data = currentDataset.map(d => ({
                    x: d.temperature,
                    y: d.precipitation,
                    r: d.humidity / 2
                }));
            } else {
                createScatterChart(ctx);
                currentChart.config.type = 'bubble';
                currentChart.update();
                return;
            }
            
            currentChart = new Chart(ctx, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: '气泡图',
                        data: data,
                        backgroundColor: colors[0] + '80'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 800 }
                }
            });
        }

        // 初始化加载数据
        window.addEventListener('load', function() {
            loadDataset('exam');
        });
    </script>
</body>
</html>